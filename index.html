<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hear Us — Simple Hand Gestures</title>
  <style>
    :root{font-family:Inter,system-ui,Arial;margin:0}
    /* New light theme */
    body{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px;background:linear-gradient(180deg,#e6f7ff,#f8fafc);color:#04293a}
    .card{background:white;border:1px solid rgba(4,41,58,0.06);padding:18px;border-radius:14px;box-shadow:0 10px 30px rgba(4,41,58,0.06);width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:24px;margin:0;color:#04293a}
    #videoElement{width:100%;height:auto;border-radius:8px;background:#000}
    canvas{position:absolute;left:0;top:0}
    .video-wrap{position:relative}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#0ea5a0;color:white;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;border:1px solid rgba(4,41,58,0.08);color:#04293a}
    .label{margin-top:8px;font-weight:700}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f1fbfb;padding:6px 8px;border-radius:999px;font-size:13px;color:#04515c}
    footer{opacity:0.8;font-size:13px;margin-top:12px}
    .tips{font-size:13px;opacity:0.9;margin-top:8px}

    /* Intro page full screen */
    .intro{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0ea5a0,#38bdf8);z-index:90}
    .intro-card{background:transparent;padding:26px;border-radius:12px;width:92%;max-width:760px;color:white;text-align:center}
    .intro-card h2{font-size:44px;margin:0 0 8px 0}
    .intro-card p{font-size:18px;opacity:0.95}
    .intro .actions{margin-top:22px;display:flex;gap:10px;justify-content:center}

    /* center big caption */
    .caption-center{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.92);padding:18px 26px;border-radius:12px;border:2px solid rgba(4,41,58,0.06);font-size:34px;font-weight:800;color:#04293a;z-index:80;display:none}
  </style>
</head>
<body>

  <!-- Intro full page -->
  <div class="intro" id="introScreen">
    <div class="intro-card">
      <h2>Hear Us</h2>
      <p>Convert simple hand gestures into readable captions. Sign in to personalize or continue as guest.</p>
      <div class="actions">
        <input id="introName" type="text" placeholder="Your name (optional)" style="padding:10px;border-radius:8px;border:0;min-width:260px" />
        <button id="introStart">Start</button>
        <button id="introSignIn" class="ghost">Sign in</button>
      </div>
    </div>
  </div>

  <div class="card" id="appCard" style="display:none">
    <header>
      <div>
        <h1>Hear Us — Hand Gestures</h1>
        <div style="opacity:0.8;font-size:13px">Live demo — gestures → captions</div>
      </div>
      <div id="userGreeting" style="text-align:right;opacity:0.95">Guest</div>
    </header>

    <div class="video-wrap" style="margin-top:12px">
      <video id="videoElement" autoplay playsinline></video>
      <canvas id="outputCanvas"></canvas>
    </div>

    <div class="controls">
      <button id="startBtn">Start Camera</button>
      <button id="stopBtn" disabled>Stop Camera</button>
      <button id="captureBtn">Capture Snapshot</button>
      <button id="calibrateBtn" class="ghost">Calibrate</button>
    </div>

    <div class="label">Detected gesture: <span id="gestureLabel">—</span></div>
    <div class="legend">
      <div class="chip">Call me</div>
      <div class="chip">I love you</div>
      <div class="chip">Rock on</div>
      <div class="chip">Victory</div>
      <div class="chip">Loser</div>
      <div class="chip">OK</div>
      <div class="chip">Good job</div>
      <div class="chip">Pain</div>
      <div class="chip">Care</div>
      <div class="chip">I want to talk</div>
      <div class="chip">Good luck</div>
    </div>

    <div class="tips">Place hand in the camera view. Capture saves a snapshot with caption. Double-click the video to save a quick snapshot.</div>
    <footer>Built for HearUs — prototype</footer>
  </div>

  <div class="caption-center" id="captionCenter">Caption</div>

  <!-- MediaPipe Hands and utilities loaded from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    // Elements
    const introScreen = document.getElementById('introScreen');
    const introStart = document.getElementById('introStart');
    const introName = document.getElementById('introName');
    const appCard = document.getElementById('appCard');
    const userGreeting = document.getElementById('userGreeting');

    const videoElement = document.getElementById('videoElement');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const gestureLabel = document.getElementById('gestureLabel');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const calibrateBtn = document.getElementById('calibrateBtn');
    const captionCenter = document.getElementById('captionCenter');

    let camera = null;
    let lastCaption = '';
    let speakThrottle = 0;
    let userName = '';

    // Intro handlers
    introStart.addEventListener('click', ()=>{
      userName = introName.value.trim();
      if (userName) localStorage.setItem('hearus_name', userName);
      userGreeting.textContent = userName || 'Guest';
      introScreen.style.display = 'none';
      appCard.style.display = 'block';
    });

    // Setup media pipe
    function fitCanvas(){ canvas.width = videoElement.videoWidth || 640; canvas.height = videoElement.videoHeight || 480; }

    function distance(a,b){ const dx=(a.x-b.x)*canvas.width; const dy=(a.y-b.y)*canvas.height; return Math.sqrt(dx*dx+dy*dy); }

    function fingersExtended(landmarks){
      const tips = {thumb:4,index:8,middle:12,ring:16,pinky:20};
      const pips = {index:6,middle:10,ring:14,pinky:18};
      const ext = {};
      for (const f of ['index','middle','ring','pinky']){
        ext[f] = landmarks[tips[f]].y < landmarks[pips[f]].y - 0.02;
      }
      const thumbTip = landmarks[4];
      const indexMcp = landmarks[5];
      ext.thumb = Math.abs(thumbTip.x - indexMcp.x) > 0.07 || (thumbTip.y < indexMcp.y - 0.02);
      return ext;
    }

    function mapGesture(landmarks){
      if (!landmarks) return 'No hand';
      const ext = fingersExtended(landmarks);
      const thumb = landmarks[4];
      const index = landmarks[8];
      const middle = landmarks[12];
      const ring = landmarks[16];
      const pinky = landmarks[20];
      const wrist = landmarks[0];
      const countExt = [ext.thumb,ext.index,ext.middle,ext.ring,ext.pinky].filter(Boolean).length;

      if (distance(thumb,index) < 30) return 'OK';
      if (ext.thumb && ext.pinky && !ext.index && !ext.middle && !ext.ring) return 'Call me';
      if (ext.thumb && ext.index && ext.pinky && !ext.middle && !ext.ring) return 'I love you';
      if (ext.index && ext.pinky && !ext.middle && !ext.ring) return 'Rock on';
      if (ext.index && ext.middle && !ext.ring && !ext.pinky) return 'Victory';
      if (ext.index && ext.thumb && !ext.middle && !ext.ring && !ext.pinky) return 'Loser';
      if (ext.thumb && !ext.index && !ext.middle && !ext.ring && !ext.pinky && (thumb.y < wrist.y - 0.03)) return 'Good job';
      if (countExt === 0) return 'Pain / Hurts a lot';
      if (countExt >= 4) return 'Care / Open palm';
      if (ext.index && !ext.middle && Math.abs(index.x-middle.x) < 0.05) return 'Good luck';
      if (ext.index && !ext.middle && !ext.ring && !ext.pinky) return 'I want to talk';
      return countExt + ' fingers';
    }

    const hands = new Hands({locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.6,minTrackingConfidence:0.6});
    hands.onResults(onResults);

    function onResults(results){
      if (!videoElement.videoWidth) return;
      fitCanvas();
      ctx.save(); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(videoElement,0,0,canvas.width,canvas.height);
      if (results.multiHandLandmarks && results.multiHandLandmarks.length>0){
        for (const landmarks of results.multiHandLandmarks){
          drawLandmarks(ctx,landmarks,{color:'#04515c',lineWidth:2});
          drawConnectors(ctx,landmarks, HAND_CONNECTIONS, {color:'#68d8d6',lineWidth:2});
          const g = mapGesture(landmarks);
          gestureLabel.textContent = g;
          lastCaption = g;
          showCaptionCenter((userName? userName+': ':'') + g);
          maybeSpeak((userName? userName+': ':'') + g);
        }
      } else {
        gestureLabel.textContent = 'No hand detected';
        hideCaptionCenter();
      }
      ctx.restore();
    }

    // Center caption control
    function showCaptionCenter(text){ captionCenter.textContent = text; captionCenter.style.display='block'; }
    function hideCaptionCenter(){ captionCenter.style.display='none'; }

    // Speech with simple throttle (speak when caption changes and at most every 1.8s)
    function maybeSpeak(text){
      const now = Date.now();
      if (text === lastSpokenText) return;
      if (now - speakThrottle < 1800) return;
      if (!('speechSynthesis' in window)) return;
      lastSpokenText = text;
      speakThrottle = now;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
    let lastSpokenText = '';

    // Start / stop camera
    startBtn.addEventListener('click', async ()=>{
      startBtn.disabled = true; stopBtn.disabled = false;
      try{
        camera = new Camera(videoElement, {onFrame: async ()=>{ await hands.send({image: videoElement}); }, width:1280,height:720});
        camera.start();
      }catch(err){
        console.error('Camera start failed',err);
        alert('Could not start camera. Check permission.');
        startBtn.disabled = false; stopBtn.disabled = true;
      }
    });

    stopBtn.addEventListener('click', ()=>{
      // stop MediaPipe camera if present
      try{
        if (camera && typeof camera.stop === 'function') camera.stop();
      }catch(e){console.warn('error stopping camera',e)}
      // also stop any underlying tracks
      if (videoElement.srcObject){
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(t=>t.stop());
        videoElement.srcObject = null;
      }
      startBtn.disabled = false; stopBtn.disabled = true; gestureLabel.textContent='—'; hideCaptionCenter();
    });

    calibrateBtn.addEventListener('click', ()=>{ alert('Calibration: try moving hand closer and adjust lighting.'); });

    // Capture snapshot (bake caption in image)
    captureBtn.addEventListener('click', ()=>{
      // draw caption strip
      ctx.save(); ctx.fillStyle='rgba(255,255,255,0.92)'; ctx.fillRect(0,canvas.height-100,canvas.width,100);
      ctx.fillStyle='#04293a'; ctx.font='36px system-ui'; const text = (userName? userName+': ':'') + (lastCaption||'No caption'); ctx.fillText(text,20,canvas.height-40); ctx.restore();
      const link = document.createElement('a'); link.download = 'hearus_snapshot.png'; link.href = canvas.toDataURL('image/png'); link.click();
    });

    // small drawing helpers
    function drawLandmarks(ctx, landmarks, style){ for (const lm of landmarks){ ctx.beginPath(); ctx.arc(lm.x * canvas.width, lm.y * canvas.height, 5, 0, Math.PI*2); ctx.fillStyle = style.color||'#ff0'; ctx.fill(); } }
    function drawConnectors(ctx, landmarks, connections, style){ ctx.lineWidth = style.lineWidth||2; ctx.strokeStyle = style.color||'#0f0'; for (const pair of connections){ const a=landmarks[pair[0]]; const b=landmarks[pair[1]]; ctx.beginPath(); ctx.moveTo(a.x*canvas.width,a.y*canvas.height); ctx.lineTo(b.x*canvas.width,b.y*canvas.height); ctx.stroke(); } }
    const HAND_CONNECTIONS = [[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20]];

    // load stored name if present and prefill
    (function(){ const n = localStorage.getItem('hearus_name'); if (n){ introName.value = n; userName = n; userGreeting.textContent = n; }})();

    // allow double click snapshot
    canvas.addEventListener('dblclick', ()=>{ const link=document.createElement('a'); link.download='gesture-snapshot.png'; link.href=canvas.toDataURL('image/png'); link.click(); });

    videoElement.addEventListener('loadedmetadata', fitCanvas);

  </script>
</body>
</html>
